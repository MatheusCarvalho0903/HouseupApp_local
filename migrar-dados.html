<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico HouseUp</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; background: #007bff; color: white; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagn√≥stico HouseUp</h1>
        
        <button class="btn" onclick="testeBasico()">1. Teste B√°sico</button>
        <button class="btn" onclick="testeFirebase()">2. Teste Firebase</button>
        <button class="btn" onclick="criarProjetosSimples()">3. Criar Projetos</button>
        <button class="btn" onclick="limparConsole()">Limpar Log</button>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function limparConsole() {
            document.getElementById('log').innerHTML = '';
        }

        function testeBasico() {
            log("üöÄ Iniciando teste b√°sico...");
            log("‚úÖ JavaScript funcionando");
            log("‚úÖ Fun√ß√µes carregadas");
            
            try {
                log("üîç Testando localStorage...");
                localStorage.setItem('teste', 'ok');
                const teste = localStorage.getItem('teste');
                log(`‚úÖ localStorage: ${teste}`);
                
                log("üåê Testando fetch...");
                fetch('https://jsonplaceholder.typicode.com/posts/1')
                    .then(response => response.json())
                    .then(data => log("‚úÖ Fetch funcionando: " + data.title))
                    .catch(error => log("‚ùå Erro no fetch: " + error.message, 'error'));
                    
            } catch (error) {
                log("‚ùå Erro no teste b√°sico: " + error.message, 'error');
            }
        }

        async function testeFirebase() {
            log("üî• Testando Firebase...");
            
            try {
                // Verificar se Firebase est√° carregado
                if (typeof firebase === 'undefined') {
                    log("‚ùå Firebase n√£o carregado!", 'error');
                    return;
                }
                log("‚úÖ Firebase SDK carregado");

                // Configurar Firebase
                const firebaseConfig = {
                    apiKey: "AIzaSyDq3mr-ryX_q8GAEyfTsQP2mzjpP9wOugE",
                    authDomain: "houseup-app.firebaseapp.com",
                    projectId: "houseup-app",
                    storageBucket: "houseup-app.firebasestorage.app",
                    messagingSenderId: "401114152723",
                    appId: "1:401114152723:web:f96eaf0a718342c0cf64e6"
                };

                // Inicializar Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    log("‚úÖ Firebase inicializado");
                } else {
                    log("‚úÖ Firebase j√° estava inicializado");
                }

                // Testar Firestore
                const db = firebase.firestore();
                log("‚úÖ Firestore conectado");

                // Teste simples de leitura
                log("üìñ Testando leitura...");
                const testDoc = await db.collection('teste').doc('conexao').get();
                log("‚úÖ Leitura funcionando (documento pode n√£o existir, mas conex√£o OK)");

                // Teste simples de escrita
                log("‚úçÔ∏è Testando escrita...");
                await db.collection('teste').doc('conexao').set({
                    timestamp: new Date().toISOString(),
                    teste: 'conexao_ok'
                });
                log("‚úÖ Escrita funcionando");

                // Verificar dados antigos
                log("üîç Verificando dados antigos...");
                const docAntigo = await db.collection('dados').doc('houseupData').get();
                if (docAntigo.exists) {
                    const dados = docAntigo.data();
                    log("‚úÖ DADOS ANTIGOS ENCONTRADOS!", 'success');
                    log(`üìã Nome: ${dados.nome_obra || 'N/A'}`);
                    log(`üî¢ C√≥digo: ${dados.codigo_obra || 'N/A'}`);
                    log(`üìä Cronograma: ${dados.cronograma?.length || 0} atividades`);
                    log(`üí∞ Material: R$ ${dados.gastos?.material || 0}`);
                    log(`üë∑ M√£o de obra: R$ ${dados.gastos?.mao_de_obra || 0}`);
                } else {
                    log("‚ö†Ô∏è Nenhum dado antigo encontrado", 'warning');
                }

                // Verificar projetos atuais
                log("üìÅ Verificando projetos atuais...");
                const projetos = await db.collection('projetos').get();
                log(`üìä Projetos encontrados: ${projetos.size}`);
                
                projetos.forEach(doc => {
                    const projeto = doc.data();
                    log(`  üìÅ ${doc.id}: ${projeto.info_projeto?.nome_obra || 'Sem nome'}`);
                });

                window.db = db; // Salvar para uso posterior
                log("üéâ FIREBASE FUNCIONANDO PERFEITAMENTE!", 'success');

            } catch (error) {
                log("‚ùå ERRO NO FIREBASE: " + error.message, 'error');
                log("‚ùå Stack: " + error.stack, 'error');
            }
        }

async function criarProjetosSimples() {
    log("üèóÔ∏è Criando projetos...");
    
    if (!window.db) {
        log("‚ùå Execute o teste Firebase primeiro!", 'error');
        return;
    }

    try {
        // Buscar dados antigos primeiro - CORRE√á√ÉO AQUI!
        const docAntigo = await window.db.collection('dados').doc('houseupData').get();
        let cronogramaAntigo = [];
        let gastosAntigos = { material: 0, mao_de_obra: 0 };
        let nomeObraAntigo = "Casa do Matheus - Projeto Veraneio";
        let codigoObraAntigo = "HOUS-001-2024";

        if (docAntigo.exists) { // ‚úÖ CORRE√á√ÉO: sem par√™nteses!
            const dados = docAntigo.data();
            cronogramaAntigo = dados.cronograma || [];
            gastosAntigos = dados.gastos || { material: 0, mao_de_obra: 0 };
            nomeObraAntigo = dados.nome_obra || nomeObraAntigo;
            codigoObraAntigo = dados.codigo_obra || codigoObraAntigo;
            log("‚úÖ Dados antigos recuperados para migra√ß√£o");
            log(`üìä Migrando ${cronogramaAntigo.length} atividades`);
            log(`üí∞ Migrando R$ ${gastosAntigos.material} em materiais`);
            log(`üë∑ Migrando R$ ${gastosAntigos.mao_de_obra} em m√£o de obra`);
        } else {
            log("‚ö†Ô∏è Documento antigo n√£o existe, criando projetos vazios", 'warning');
        }

        // Projeto Angela e Marco (com dados migrados)
        const angelaMarco = {
            info_projeto: {
                nome_obra: "Resid√™ncia Angela e Marco",
                codigo_obra: "HOUS-001-2024",
                tipo_construcao: "terrea",
                area_total: 245,
                clientes: ["Angela", "Marco"],
                endereco: "Araguari - MG",
                data_inicio: "2024-10-15",
                prazo_meses: 18,
                status: "em_andamento",
                orcamento_total: 450000.00,
                observacoes: "Casa t√©rrea para casal idoso - DADOS MIGRADOS"
            },
            progresso_geral: calcularProgressoGlobal(cronogramaAntigo),
            orcamento: {
                valor_total_previsto: 450000.00,
                valor_material_previsto: 270000.00,
                valor_mao_obra_previsto: 180000.00,
                data_criacao: "2024-10-15",
                margem_contingencia: 10.0
            },
            gastos: {
                material: { 
                    total_realizado: gastosAntigos.material || 0, 
                    historico: [] 
                },
                mao_de_obra: { 
                    total_realizado: gastosAntigos.mao_de_obra || 0, 
                    historico: [] 
                },
                equipamentos: { total_realizado: 0, historico: [] },
                servicos_terceiros: { total_realizado: 0, historico: [] }
            },
            cronograma: cronogramaAntigo, // ‚úÖ Seus dados antigos aqui!
            criado_em: new Date().toISOString(),
            migrado_de: "dados_antigos"
        };

        // Sobrescrever o projeto Angela e Marco
        await window.db.collection('projetos').doc('angela-marco').set(angelaMarco);
        log("‚úÖ Projeto Angela e Marco atualizado com dados migrados", 'success');

        // Projeto Marco Jr e Tuane (novo)
        const marcoJrTuane = {
            info_projeto: {
                nome_obra: "Resid√™ncia Marco Jr e Tuane",
                codigo_obra: "HOUS-002-2024",
                tipo_construcao: "sobrado",
                area_total: 356,
                clientes: ["Marco Jr", "Tuane"],
                endereco: "Araguari - MG",
                data_inicio: "2024-11-01",
                prazo_meses: 18,
                status: "em_andamento",
                orcamento_total: 650000.00,
                observacoes: "Sobrado alto padr√£o com elevador e piscina"
            },
            progresso_geral: 8.2,
            orcamento: {
                valor_total_previsto: 650000.00,
                valor_material_previsto: 390000.00,
                valor_mao_obra_previsto: 260000.00,
                data_criacao: "2024-11-01",
                margem_contingencia: 10.0
            },
            gastos: {
                material: { total_realizado: 0, historico: [] },
                mao_de_obra: { total_realizado: 0, historico: [] },
                equipamentos: { total_realizado: 0, historico: [] },
                servicos_terceiros: { total_realizado: 0, historico: [] }
            },
            cronograma: criarCronogramaSobrado(),
            criado_em: new Date().toISOString()
        };

        await window.db.collection('projetos').doc('marco-jr-tuane').set(marcoJrTuane);
        log("‚úÖ Projeto Marco Jr e Tuane criado", 'success');

        log("üéâ MIGRA√á√ÉO CONCLU√çDA COM SUCESSO!", 'success');
        log("üìã Seus 17 atividades foram migradas para Angela e Marco");
        log("üí∞ Seus R$ 1.300 em materiais foram migrados");
        log("üîó Agora voc√™ pode acessar a p√°gina Home e ver os projetos");

    } catch (error) {
        log("‚ùå ERRO ao criar projetos: " + error.message, 'error');
        log("‚ùå Stack: " + error.stack, 'error');
    }
}

// Fun√ß√£o auxiliar para calcular progresso
function calcularProgressoGlobal(cronograma) {
    if (!cronograma || cronograma.length === 0) return 0;
    
    let progressoTotal = 0;
    let pesoTotal = 0;
    
    cronograma.forEach(atividade => {
        const peso = parseFloat(atividade.peso_global) || 0;
        const progresso = parseFloat(atividade.progresso_atividade) || 0;
        progressoTotal += peso * progresso;
        pesoTotal += peso;
    });
    
    return pesoTotal > 0 ? (progressoTotal / pesoTotal) : 0;
}

// Fun√ß√£o para criar cronograma do sobrado
function criarCronogramaSobrado() {
    return [
        {
            id: "ATV001",
            descricao: "Funda√ß√£o Sobrado",
            peso_global: 15,
            progresso_atividade: 0,
            status: "N√£o Iniciada",
            prazo_final: "2025-01-15",
            sub_atividades: [
                {
                    id: "SUB001",
                    descricao: "Escava√ß√£o com carga para elevador",
                    peso_local: 8,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-01-10"
                },
                {
                    id: "SUB002",
                    descricao: "Funda√ß√£o casa de m√°quinas",
                    peso_local: 7,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-01-15"
                }
            ]
        },
        {
            id: "ATV002",
            descricao: "Estrutura Dois Pavimentos",
            peso_global: 25,
            progresso_atividade: 0,
            status: "N√£o Iniciada",
            prazo_final: "2025-03-15",
            sub_atividades: [
                {
                    id: "SUB003",
                    descricao: "Pilares t√©rreo",
                    peso_local: 10,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-02-15"
                },
                {
                    id: "SUB004",
                    descricao: "Laje 1¬∫ pavimento",
                    peso_local: 8,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-02-28"
                },
                {
                    id: "SUB005",
                    descricao: "Pilares 1¬∫ pavimento",
                    peso_local: 7,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-03-15"
                }
            ]
        },
        {
            id: "ATV003",
            descricao: "Instala√ß√µes Especiais",
            peso_global: 15,
            progresso_atividade: 0,
            status: "N√£o Iniciada",
            prazo_final: "2025-05-15",
            sub_atividades: [
                {
                    id: "SUB006",
                    descricao: "Shaft do elevador",
                    peso_local: 8,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-04-15"
                },
                {
                    id: "SUB007",
                    descricao: "Instala√ß√µes da piscina",
                    peso_local: 7,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-05-15"
                }
            ]
        },
        {
            id: "ATV004",
            descricao: "Acabamentos Alto Padr√£o",
            peso_global: 45,
            progresso_atividade: 0,
            status: "N√£o Iniciada",
            prazo_final: "2025-08-15",
            sub_atividades: [
                {
                    id: "SUB008",
                    descricao: "Pisos especiais",
                    peso_local: 20,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-07-15"
                },
                {
                    id: "SUB009",
                    descricao: "Automa√ß√£o residencial",
                    peso_local: 15,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-08-01"
                },
                {
                    id: "SUB010",
                    descricao: "Instala√ß√£o do elevador",
                    peso_local: 10,
                    progresso_atividade: 0,
                    status: "N√£o Iniciada",
                    prazo_final: "2025-08-15"
                }
            ]
        }
    ];
}
    </script>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</body>
</html>